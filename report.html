<html>
    <head>
        <script type="text/javascript" src="/js/excel-builder/report/jquery-1.11.2.min.js"></script>
        <script type="text/javascript" src="/js/excel-builder/report/require.js"></script>
        <script type="text/javascript" src="/js/excel-builder/report/underscore-min.js"></script>
        <script type="text/javascript" src="/js/excel-builder/report/json2.js"></script>
        <script type="text/javascript" src="/js/excel-builder/report/downloadify/js/swfobject.js"></script>
        <script type="text/javascript" src="/js/excel-builder/report/downloadify/js/downloadify.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Arimo:400,700,400italic,700italic">
    </head>
    <body>

        <div id="" style="margin: 30px auto; width:500px; border: 3px double #ddd; font-family: 'Arimo', sans-serif; background-color: #009; font-size: 36px; text-align: center; color: #fff;">

            <h3 id="status" style="font-weight:normal;">Generating report...</h3>

            <pre id="complete" style="display:none;"><a style="color:#fff;" href="#" id="downloader" download="grant_report.xlsx">Download Report File</a></pre>

        </div>

        <script type="text/javascript">
            require.config({
                paths: {
                    JSZip: '/js/excel-builder/report/jszip.min',
                    text: '/js/excel-builder/report/text'
                },
                shim: {
                    'JSZip': {
                        exports: 'JSZip'
                    }
                }
            });
            require(['js/excel-builder/excel-builder', 'js/excel-builder/Template/BasicReport'], function (builder, SummaryReport) {

                var report_data;

                var parsePaymentRequests = function(payment_requests) {

                    var stats = {
                            lastPaid: {
                                created: null,
                                servicePeriod: null
                            },
                            lastInvoiced: {
                                created: null,
                                servicePeriod: null
                            },
                            drawnTotal: 0
                        },
                        request_date;

                    _.each(payment_requests, function(payment, index) {

                        request_date = new Date(payment.created).getTime();

                        if (payment.status === 'paid') {

                            stats.drawnTotal += payment.drawdown;

                            if (!stats.lastPaid.created || stats.lastPaid.created < request_date) {
                                stats.lastPaid.created = request_date;
                                stats.lastPaid.servicePeriod = payment.service_period;
                            }

                        } else if (!stats.lastInvoiced.created || stats.lastInvoiced.created < request_date) {
                            stats.lastInvoiced.created = request_date;
                            stats.lastInvoiced.servicePeriod = payment.service_period;
                        }

                    });

                    return stats;

                }

                var prepareReportData = function(data) {

                    var parsed = [],
                        payment_request_stats;

                    _.each(data.grants, function(grant, index) {

                        payment_request_stats = parsePaymentRequests(grant.payment_requests);

                        parsed.push([
                            grant.id,
                            grant.provider.name,
                            grant.budget,
                            payment_request_stats.drawnTotal,
                            (grant.budget - payment_request_stats.drawnTotal),
                            grant.endDate,
                            grant.comments,
                            payment_request_stats.lastPaid.servicePeriod,
                            payment_request_stats.lastInvoiced.servicePeriod
                        ]);

                    });

                    return parsed;

                }

                var processReport = function(data) {

                    var summaryReport = new SummaryReport();
                    var columns = [
                        {id: 'grant_id', name: "Grant ID", type: 'string', width: 50},
                        {id: 'provider', name:"Provider", type: 'string', width: 50},
                        {id: 'budget', name: "Total Budget", type: 'number', style: summaryReport.predefinedFormatters.currency.id},
                        {id: 'drawn', name: "Total Drawn", type: 'number', style: summaryReport.predefinedFormatters.currency.id},
                        {id: 'remainder', name: "Remainder", type: 'number', style: summaryReport.predefinedFormatters.currency.id},
                        {id: 'endDate', name: "End Date", type: 'date', style: summaryReport.predefinedFormatters.date.id, width: 15},
                        {id: 'comments', name: "Comments", type: 'string', width: 100},
                        {id: 'lastPaid', name: "Last Period Paid", type: 'string', width: 50},
                        {id: 'lastInvoiced', name: "Last Period Invoiced", type: 'string', width: 50}
                    ];

                    var worksheetData = [
                        [
                            {value: "Grant ID", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                            {value: "Provider", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                            {value: "Budget", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                            {value: "Drawn", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                            {value: "Remainder", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                            {value: "End Date", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                            {value: "Comments", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                            {value: "Last Paid Period", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                            {value: "Last Invoiced Period", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}}
                        ]
                    ].concat(data);

                    summaryReport.setHeader([
                        {bold: true, text: "Grant Summary Report"}, "", ""
                    ]);
                    summaryReport.setData(worksheetData);
                    summaryReport.setColumns(columns);
                    summaryReport.setFooter([
                        '', '', 'Page &P of &N'
                    ]);
                    if('download' in document.createElement('a')){
                        $("#downloader").attr({
                            href: "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,"+builder.createFile(summaryReport.prepare())
                        });
                    } else {
                        Downloadify.create('downloader',{
                            filename: function(){
                                    return "grant_report.xlsx";
                            },
                            data: function(){
                                    return builder.createFile(summaryReport.prepare());
                            },
                            swf: '/js/excel-builder/report/downloadify/media/downloadify.swf',
                            downloadImage: '/js/excel-builder/report/downloadify/images/download.png',
                            width: 100,
                            dataType: 'base64',
                            height: 30,
                            transparent: true,
                            append: false
                        });
                    }

                }

                //Detect access token in URL.
                //  If not present, redirect to AUTH endpoint
                //  If present
                //      Connect with Zengine API
                //      Lookup user Grants, with associated Provider + PaymentRequests

                $.ajax({
                    url: 'http://127.0.0.1:4000/js/excel-builder/report/testreport.json',
                    dataType: 'json',
                    type: 'GET',
                    success: function(response) {

                        report_data = prepareReportData(response.data);

                        processReport(report_data);

                        $('#status').text('Report Complete');
                        $('#complete').show();

                    }
                });


            });

        </script>

    </body>
</html>
