<html>
    <head>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>

        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.1.11/require.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/json2/20110223/json2.js"></script>
        <script type="text/javascript" src="downloadify/js/swfobject.js"></script>
        <script type="text/javascript" src="downloadify/js/downloadify.min.js"></script>
    </head>
    <body>

        <pre id="preview"><a href="#" id="downloader" download="grant_report.xlsx">Click me!</a></pre>

        <script type="text/javascript">
            require.config({
                text: 'text.js',
                paths: {
                    JSZip: 'http://cdnjs.cloudflare.com/ajax/libs/jszip/2.0.0/jszip'
                },
                shim: {
                    'JSZip': {
                        exports: 'JSZip'
                    }
                }
            });
            require(['../excel-builder', 'text!testdata.json', '../Template/BasicReport'], function (builder, data, BasicReport) {
                var data = JSON.parse(data);
                /* for converting data sets from key-> value to array of values
                var stuff = [];
                for(var i = 0, l = data.length; i < l; i++) {
                    var d = data[i];
                    stuff[i] = [
                        d.id,
                        d.name,
                        d.price,
                        d.location,
                        d.startDate,
                        d.endDate
                    ];
                }
                */
                var summaryReport = new SummaryReport();
                var columns = [
                    {id: 'grant_id', name: "Grant ID", type: 'string', width: 50},
                    {id: 'provider', name:"Provider", type: 'string', width: 50},
                    {id: 'budget', name: "Total Budget", type: 'number', style: summaryReport.predefinedFormatters.currency.id},
                    {id: 'drawn', name: "Total Drawn", type: 'number', style: summaryReport.predefinedFormatters.currency.id},
                    {id: 'remainder', name: "Remainder", type: 'number', style: summaryReport.predefinedFormatters.currency.id},
                    {id: 'endDate', name: "End Date", type: 'date', style: summaryReport.predefinedFormatters.date.id, width: 15},
                    {id: 'comments', name: "Comments", type: 'string', width: 100},
                    {id: 'lastPaid', name: "Last Period Paid", type: 'string', width: 50},
                    {id: 'lastInvoiced', name: "Last Period Invoiced", type: 'string', width: 50}
                ];

                var worksheetData = [
                    [
                        {value: "Grant ID", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                        {value: "Provider", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                        {value: "Budget", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                        {value: "Drawn", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                        {value: "Remainder", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}},
                        {value: "End Date", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}}
                        {value: "Comments", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}}
                        {value: "Last Paid Period", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}}
                        {value: "Last Invoiced Period", metadata: {style: summaryReport.predefinedFormatters.header.id, type: 'string'}}
                    ]
                ].concat(data);

                summaryReport.setHeader([
                    {bold: true, text: "Grant Summary Report"}, "", ""
                ]);
                summaryReport.setData(worksheetData);
                summaryReport.setColumns(columns);
                summaryReport.setFooter([
                    '', '', 'Page &P of &N'
                ]);
                if('download' in document.createElement('a')){
                    $("#downloader").attr({
                        href: "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,"+builder.createFile(summaryReport.prepare())
                    });
                } else {
                    Downloadify.create('downloader',{
                            filename: function(){
                                    return "sample.xlsx";
                            },
                            data: function(){
                                    return builder.createFile(summaryReport.prepare());
                            },
//                            onComplete: function(){ alert('Your File Has Been Saved!'); },
//                            onCancel: function(){ alert('You have cancelled the saving of this file.'); },
//                            onError: function(){ alert('You must put something in the File Contents or there will be nothing to save!'); },
                            swf: 'downloadify/media/downloadify.swf',
                            downloadImage: 'downloadify/images/download.png',
                            width: 100,
                            dataType: 'base64',
                            height: 30,
                            transparent: true,
                            append: false
                    });
                }
            });

        </script>

    </body>
</html>
